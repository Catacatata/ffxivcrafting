var crafting={init:function(){crafting.events(),crafting_tour.init()},events:function(){$("#self_sufficient_switch, #misc_items_switch").change(function(){$(this).closest("form").submit()}),$("#obtain-these-items .collapse").click(function(){var a=$(this);a.toggleClass("glyphicon-chevron-down").toggleClass("glyphicon-chevron-up");var b=$(this).closest("tbody"),c=b.find("tr:not(:first-child)");c.toggleClass("hidden")}),$(".needed input").change(function(){var a=$(this).closest("#CraftingList-section").length>0;return crafting.recalculate_all(a)}),$("input.obtained").change(function(){var a=$(this).closest("#CraftingList-section").length>0;return crafting.recalculate_all(a)}),$(".obtained-ok").click(function(){var a=$(this).closest("tr"),b=$("td.total",a).html();$("input.obtained",a).val(b).trigger("change")}),crafting.init_reagents(),crafting.recalculate_all(!0),$(".vendors").on("click",function(a){a.preventDefault();var b=$(this),c=b.closest(".reagent").data("itemId");if(!b.hasClass("loading")){var d=$("#vendors_for_"+c);0==d.length?$.ajax({url:"/vendors/view/"+c,dataType:"json",beforeSend:function(){b.addClass("loading"),global.noty({type:"warning",text:"Loading Vendors"})},success:function(a){$("body").append(a.html),$("#vendors_for_"+c).modal(),b.removeClass("loading")}}):$("#vendors_for_"+c).modal("show")}}),$(".clusters").on("click",function(a){a.preventDefault();{var b=$(this),c=b.closest(".reagent").data("itemId");b.data("classjobId")}if(!b.hasClass("loading")){var d=$("#clusters_for_"+c);0==d.length?$.ajax({url:"/gathering/clusters/"+c,dataType:"json",beforeSend:function(){b.addClass("loading"),global.noty({type:"warning",text:"Loading Clusters"})},success:function(a){$("body").append(a.html),$("#clusters_for_"+c).modal(),b.removeClass("loading")}}):$("#clusters_for_"+c).modal("show")}}),$(".beasts").on("click",function(a){a.preventDefault();var b=$(this),c=b.data("itemId");if(!b.hasClass("loading")){var d=$("#beasts_for_"+c);0==d.length?$.ajax({url:"/gathering/beasts/"+c,dataType:"json",beforeSend:function(){b.addClass("loading"),global.noty({type:"warning",text:"Loading Beasts"})},success:function(a){$("body").append(a.html),$("#beasts_for_"+c).modal(),b.removeClass("loading")}}):$("#beasts_for_"+c).modal("show")}}),$("#map_it").click(function(a){a.preventDefault(),global.noty({type:"warning",text:"Loading Map"});var b=[];$("#Gathered-section, #Bought-section, #Other-section").find("tr.reagent").each(function(){var a=$(this),c=a.data("itemId"),d=a.find(".needed span").html();b[b.length]=c+"|"+d}),b=b.join("||"),$('<form action="/map" method="POST"><input type="hidden" name="items" value="'+b+'"></form>').submit()})},reagents:[],init_reagents:function(){$(".reagent").each(function(){var a=$(this),b={name:a.find('a[href^="http"]').text().trim(),exempt:a.hasClass("exempt"),item_id:a.data("itemId"),yields:a.data("yields"),reagents:[],needed:0,obtained:0,total:0,elements:{row:a,needed:$("td.needed span",a).length>0?$("td.needed span",a):$("td.needed input",a),obtained:$("input.obtained",a),total:$("td.total",a)}};if(requires=a.data("requires").split("&"),b.exempt&&$("tr.reagent:not(.exempt)[data-item-id="+b.item_id+"]").length>0&&(requires[requires.length]="1x"+b.item_id),1==requires.length&&""==requires[0])b.reagents=null;else for(var c=0;c<requires.length;c++){var d=requires[c].split("x");b.reagents[b.reagents.length]={item_id:d[1],quantity:parseInt(d[0])}}crafting.reagents[crafting.reagents.length]=b})},recalculate_all:function(a){for(var b=0;b<crafting.reagents.length;b++){var c=crafting.reagents[b];if(c.obtained=parseInt(c.elements.obtained.val()),c.total=0,1==c.exempt){c.needed=parseInt(c.elements.needed.val()),c.elements.obtained.attr("max",c.needed),c.elements.row[(c.needed-c.obtained==0?"add":"remove")+"Class"]("success");var d=Math.ceil(Math.max(c.needed-c.obtained,0)/c.yields);crafting.oven(c,d,a)}else c.needed=0}for(var b=0;b<crafting.reagents.length;b++){var c=crafting.reagents[b];if(1!=c.exempt&&null!=c.reagents){var d=Math.ceil(Math.min(0-c.obtained,0)/c.yields);crafting.oven(c,d,a)}}for(var b=0;b<crafting.reagents.length;b++){var c=crafting.reagents[b];if(1!=c.exempt){if(c.needed=c.needed-c.obtained,c.needed<0){c.obtained+=c.needed;var e=Math.ceil(c.obtained/c.yields)*c.yields;c.elements.obtained.val(0>e?0:e),c.needed=0}var f=Math.ceil(c.needed/c.yields)*c.yields,g=Math.ceil(c.total/c.yields)*c.yields;c.elements.needed.html(f),c.elements.obtained.attr("max",g),c.elements.total.html(c.total<0?0:c.total),c.elements.row[(0==c.needed?"add":"remove")+"Class"]("success")}}},oven:function(a,b,c){if(null!=a.reagents)a:for(var d=0;d<a.reagents.length;d++)for(var e=a.reagents[d],f=0;f<crafting.reagents.length;f++){var g=crafting.reagents[f];if(g.item_id==e.item_id){var h=b*e.quantity;g.needed+=h,g.total+=h;var i=Math.ceil(h/g.yields);crafting.oven(g,i,c);continue a}}}},crafting_tour={tour:null,first_run:!0,init:function(){var a=$("#start_tour");crafting_tour.tour=new Tour({orphan:!0,onStart:function(){return a.addClass("disabled",!0)},onEnd:function(){return a.removeClass("disabled",!0)}}),a.click(function(a){a.preventDefault(),$("#toggle-slim").bootstrapSwitch("status")&&$("#toggle-slim").bootstrapSwitch("setState",!1),1==crafting_tour.first_run&&crafting_tour.build(),$(this).hasClass("disabled")||crafting_tour.tour.restart()})},build:function(){crafting_tour.tour.addSteps([{element:"#CraftingList-section",title:"Recipe List",content:"The list at the bottom is your official Recipe List.  You will be making these items.",placement:"top"},{element:"#Gathered-section tr:first-child",title:"Gathered Section",content:"Items you can gather with MIN, BTN or FSH will appear in the Gathered Section.",placement:"bottom"},{element:"#Bought-section tr:first-child",title:"Bought Section",content:"Items you cannot gather will be thrown into the Bought Section.",placement:"bottom"},{element:"#Other-section tr:first-child",title:"Other Section",content:"Items that cannot be bought or gathered show up in the Other Section.  Most likely these will involve monster drops.",placement:"bottom"},{element:"#PreRequisiteCrafting-section tr:first-child",title:"Pre-Requisite Crafting",content:"Why buy what you can craft?  The Crafted Section contains items necessary for your main recipes to finish.  The previous sections will already contain the sub items required.",placement:"bottom"},{element:"#self-sufficient-form",title:"Self Sufficient",content:"By default it assumes you want to be Self Sufficient.  Turning this option off will eliminate the Gathering and Crafting aspect and appropriately force the items into either Bought or Other.",placement:"top"},{element:"#leveling-information",title:"Leveling Information",content:"Pay attention to the Leveling Information box as it will give you a heads up as to what your next quest turn ins will require.",placement:"top"}]),crafting_tour.first_run=!1}};$(crafting.init);